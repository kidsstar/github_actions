name: "Apply Code Style Workflow"
on:
  workflow_call:
    secrets:
      pat_read_all_repositories:
        required: true
    inputs:
      clean:
        required: false
        type: boolean
        default: false
jobs:
  apply_code_style:
    name: "ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ã®é©ç”¨(Reusable Workflow)"
    runs-on:
      - self-hosted
      - apply-code-style
    permissions:
      contents: write
      pull-requests: write
    steps:
      # ã‚¸ãƒ§ãƒ–æ¯Žã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      - name: Create Workspace
        uses: DeNA/setup-job-workspace-action@v3
      # å¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout target branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0 # PR ç”¨ã«å±¥æ­´ã‚’ä¿æŒ
          clean: ${{ inputs.clean }}
          token: ${{ secrets.pat_read_all_repositories }}
      # ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ™‚ã«git cleanã—ã¦ãªã„å ´åˆã‚‚git reset --hardã¯è¡Œã†
      - name: Git reset
        run: |
          git reset --hard
      # æœ€æ–°ã® .editorconfig ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰å–å¾—
      - name: Import .editorconfig from template repo
        uses: actions/checkout@v4
        with:
          repository: kidsstar/editorconfig_pretendland
          ref: main
          path: editorconfig_src
          token: ${{ secrets.pat_read_all_repositories }}
      - name: Replace .editorconfig
        run: |
          cp editorconfig_src/.editorconfig ./.editorconfig
      # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§åˆ©ç”¨ã—ã¦ã„ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®Unityã‚¨ãƒ‡ã‚£ã‚¿ã®ãƒ‘ã‚¹ã‚’å–å¾—
      - name: Get Unity Editor Executable Path
        id: get_unity_editor_path
        uses: kidsstar/github_actions/.github/composite_actions/get_unity_editor_executable_path@main
        with:
          unity_project_folder: $GITHUB_WORKSPACE
      - name: echo Unity Editor Executable Path
        run: |
          echo "Unity Editor Executable Path: ${{ steps.get_unity_editor_path.outputs.unity_editor_path }}"
      # Unity CLI ã§ .sln / .csproj ã‚’ç”Ÿæˆ (UnityEditor.SyncVS.SyncSolution)
      - name: Generate solution & project files via Unity
        run: |
          ${{ steps.get_unity_editor_path.outputs.unity_editor_path }} \
            -batchmode \
            -quit \
            -logFile - \
            -projectPath . \
            -executeMethod UnityEditor.SyncVS.SyncSolution
      # ãƒ‘ãƒ“ãƒªã‚ªãƒ³ã®C#ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—
      - name: Get pavilion project filename
        id: get_pavilion_csproj
        uses: kidsstar/github_actions/.github/composite_actions/get_pavilion_csproj_name@main
        with:
          unity_project_folder: $GITHUB_WORKSPACE
          github_repository: $GITHUB_REPOSITORY
      - name: echo pavilion project filename
        run: |
          echo "Pavilion Project File: ${{ steps.get_pavilion_csproj.outputs.pavilion_project_filename }}"
      # dotnet format ã‚’å®Ÿè¡Œ
      - name: Run dotnet format
        run: |
          dotnet format ${{ steps.get_pavilion_csproj.outputs.pavilion_project_filename }} --verbosity diagnostic
      # å·®åˆ†ãŒã‚ã‚Œã°ã‚³ãƒŸãƒƒãƒˆ & PR ä½œæˆ
      - name: Create pull request if changes exist
        id: cpr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'ðŸ¤– ðŸŽ¨ Apply Code Style'
          title: 'ðŸ¤– ðŸŽ¨ [${{ github.ref_name }}] ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ã®è‡ªå‹•é©ç”¨'
          body: |
            ## ðŸ“‹ æ¦‚è¦
            ã“ã®PRã¯ã€`dotnet format` ã‚’ä½¿ç”¨ã—ã¦C#ã‚³ãƒ¼ãƒ‰ã®ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã‚’è‡ªå‹•ä¿®æ­£ã—ãŸã‚‚ã®ã§ã™ã€‚
            
            ## ðŸŽ¯ å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒ
            - **ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒ**: `${{ github.ref_name }}`
            
            ## ðŸ“ å¤‰æ›´å†…å®¹
            
            ### 1. .editorconfig ã®æ›´æ–°
            - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªï¼ˆ`kidsstar/editorconfig_pretendland`ï¼‰ã‹ã‚‰æœ€æ–°ã® `.editorconfig` ã‚’å–å¾—ã—æ›´æ–°
            - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã§çµ±ä¸€ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„ã‚’é©ç”¨
            
            ### 2. ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã®é©ç”¨
            ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã«åŸºã¥ã„ã¦ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ã‚’çµ±ä¸€ã—ã¾ã—ãŸï¼š
            - ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã®çµ±ä¸€
            - ä¸è¦ãªç©ºç™½ã®å‰Šé™¤
            - æ‹¬å¼§ã®ä½ç½®ã®èª¿æ•´
            - usingæ–‡ã®æ•´ç†
            - ãã®ä»–ã€.editorconfigã«å®šç¾©ã•ã‚ŒãŸãƒ«ãƒ¼ãƒ«ã®é©ç”¨
            
            ## âœ… ç¢ºèªäº‹é …
            - [ ] å¤‰æ›´å†…å®¹ãŒæ„å›³ã—ãŸã‚‚ã®ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
            - [ ] ãƒ“ãƒ«ãƒ‰ãŒæ­£å¸¸ã«é€šã‚‹ã“ã¨ã‚’ç¢ºèª
            - [ ] æ©Ÿèƒ½çš„ãªå¤‰æ›´ãŒå«ã¾ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèª
            
            ## ðŸ¤– è‡ªå‹•ç”Ÿæˆ
            ã“ã®PRã¯ GitHub Actions ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚
            å•é¡ŒãŒãªã‘ã‚Œã°ãã®ã¾ã¾ãƒžãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚
          branch: actions/apply_code_style/${{ github.ref_name }}
          base: ${{ github.ref_name }}
          delete-branch: true
          draft: false
          add-paths: |
            .editorconfig
            **/*.cs            
      # ä½œæˆã•ã‚ŒãŸ PR æƒ…å ±ã‚’å‡ºåŠ›ï¼ˆå·®åˆ†ãªã—ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—ï¼‰
      - name: PR info
        if: ${{ steps.cpr.outputs.pull-request-number != '' && steps.cpr.outputs.pull-request-number != '0' }}
        run: |
          echo "Created PR #${{ steps.cpr.outputs.pull-request-number }} -> ${{ steps.cpr.outputs.pull-request-url }}"
      
      # å®Ÿè¡Œã‚µãƒžãƒªãƒ¼ã‚’ç”Ÿæˆ
      - name: Generate job summary
        if: always()
        run: |
          echo "## ðŸŽ¨ ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œçµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### å®Ÿè¡Œçµæžœ" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.cpr.outputs.pull-request-number }}" != "" && "${{ steps.cpr.outputs.pull-request-number }}" != "0" ]]; then
            echo "âœ… **ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ã®ä¿®æ­£ãŒå¿…è¦ã§ã—ãŸ**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **ä½œæˆã•ã‚ŒãŸPR**: [#${{ steps.cpr.outputs.pull-request-number }}](${{ steps.cpr.outputs.pull-request-url }})" >> $GITHUB_STEP_SUMMARY
            echo "- **å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒ**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **PRãƒ–ãƒ©ãƒ³ãƒ**: \`actions/apply_code_style/${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ¨ **ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ã®ä¿®æ­£ã¯ä¸è¦ã§ã—ãŸ**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ã™ã¹ã¦ã®ã‚³ãƒ¼ãƒ‰ãŒã™ã§ã«é©åˆ‡ãªãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã«ãªã£ã¦ã„ã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### å®Ÿè¡Œæƒ…å ±" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ–ãƒ©ãƒ³ãƒ**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒªãƒã‚¸ãƒˆãƒª**: \`${{ github.repository }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Ÿè¡Œè€…**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Unity ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±" >> $GITHUB_STEP_SUMMARY
          echo "- **Unity ã‚¨ãƒ‡ã‚£ã‚¿ãƒ‘ã‚¹**: \`${{ steps.get_unity_editor_path.outputs.unity_editor_path }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ‘ãƒ“ãƒªã‚ªãƒ³ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: \`${{ steps.get_pavilion_csproj.outputs.pavilion_project_filename }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "_ã“ã®ã‚µãƒžãƒªãƒ¼ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ_" >> $GITHUB_STEP_SUMMARY
